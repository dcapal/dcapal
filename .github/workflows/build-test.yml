name: CI

on:
  push:
    branches: ["master", "dev", "rc/**"]
  pull_request:
    branches: ["master", "dev", "rc/**"]

env:
  CARGO_TERM_COLOR: always

jobs:
  backend-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2

      - name: Toolchain info
        run: |
          cargo --version --verbose
          rustc --version
          cargo clippy --version

      - name: Install SeaORM CLI
        run: cargo install sea-orm-cli

      - name: Lint
        run: |
          cd dcapal-backend
          cargo fmt --all -- --check
          cargo clippy -- -D warnings

      - name: Build and Test
        run: |
          cd dcapal-backend
          RUST_LOG=dcapal-backend=debug cargo test -- --nocapture

  optimizer-build-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: clippy, rustfmt
      - uses: Swatinem/rust-cache@v2

      - name: Install wasm-pack
        run: curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

      - name: Toolchain info
        run: |
          cargo --version --verbose
          rustc --version
          cargo clippy --version

      - name: Lint
        run: |
          cd dcapal-optimizer-wasm
          cargo fmt -- --check
          cargo clippy -- -D warnings

      - name: Test
        run: |
          cd dcapal-optimizer-wasm
          RUST_LOG=info cargo test -- --nocapture
          wasm-pack test --headless --chrome

      - name: Build
        run: |
          cd dcapal-optimizer-wasm
          wasm-pack build

      - name: Archive dcapal-optimizer-wasm pkg
        uses: actions/upload-artifact@v6
        with:
          name: dcapal-optimizer-wasm-pkg
          path: dcapal-optimizer-wasm/pkg

  frontend-check:
    runs-on: ubuntu-slim
    needs: optimizer-build-test
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: dcapal-frontend/package-lock.json

      - name: Check formatting
        run: |
          cd dcapal-frontend
          npm ci
          npm run check

      - name: Typecheck
        run: |
          cd dcapal-frontend
          npm run typecheck

  frontend-build-test:
    runs-on: ubuntu-latest
    needs: [frontend-check, optimizer-build-test]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: dcapal-frontend/package-lock.json

      - name: Download dcapal-optimizer-wasm pkg
        uses: actions/download-artifact@v7
        with:
          name: dcapal-optimizer-wasm-pkg
          path: dcapal-optimizer-wasm/pkg

      - name: Install dependencies
        run: |
          cd dcapal-frontend
          npm ci

      - name: Build
        run: |
          cd dcapal-frontend
          npm run build

      - name: Unit tests
        run: |
          cd dcapal-frontend
          npm run test:unit

  backend-smoke-test:
    timeout-minutes: 60
    runs-on: ubuntu-24.04
    env:
      POSTGRES_HOST: db
      POSTGRES_PORT: 5432
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: your-super-secret-and-long-postgres-password
      POSTGRES_DB: postgres
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build dcapal-backend image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./dcapal-backend/docker/Dockerfile
          load: true
          push: false
          tags: dcapal-backend:smoke
          cache-from: type=gha
          cache-to: type=gha,mode=max
      - name: Configure dcapal env
        run: |
          cat > dcapal-backend/dcapal.env << EOF
          POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
          POSTGRES_HOST=${POSTGRES_HOST}
          POSTGRES_USER=${POSTGRES_USER}
          POSTGRES_DB=${POSTGRES_DB}
          POSTGRES_PORT=${POSTGRES_PORT}
          EOF
      - name: Configure dcapal.yml
        run: |
          cat > dcapal-backend/dcapal.yml << EOF
          app:
            providers:
              priceProvider: kraken
              cwApiKey: CW_API_KEY
              ipApiKey: IP_API_KEY
            auth:
              jwtSecret: super-secret-jwt-token-with-at-least-32-characters-long

            log:
              level: dcapal_backend=info,tower_http=debug
              file: data/dcapal/dcapal.log
              enableStdout: true

          server:
            web:
              hostname: 0.0.0.0
              port: 8080
            metrics:
              hostname: 0.0.0.0
              port: 9000
            redis:
              hostname: redis
              port: 6379
              user: dcapal
              password: dcapal
            postgres:
              hostname: ${POSTGRES_HOST}
              port: ${POSTGRES_PORT}
              user: ${POSTGRES_USER}
              password: ${POSTGRES_PASSWORD}
              database: ${POSTGRES_DB}
          EOF
      - name: Configure docker compose override
        run: |
          cat > dcapal-backend/docker-compose.override.yml << EOF
          services:
            dcapal:
              image: dcapal-backend:smoke
              env_file: dcapal.env
          EOF
      - name: Install Supabase
        run: make supabase-up
      - name: Run backend stack and wait for health
        run: |
          cd dcapal-backend
          docker compose -f docker-compose.yml \
                         -f ./docker/docker-compose.local.yml \
                         -f docker-compose.override.yml \
                         up --no-build --wait --wait-timeout 120
      - name: Print backend logs on failure
        if: failure()
        run: |
          cd dcapal-backend
          docker compose -f docker-compose.yml \
                         -f ./docker/docker-compose.local.yml \
                         -f docker-compose.override.yml \
                         logs
      - name: Stop backend stack
        if: always()
        run: |
          cd dcapal-backend
          docker compose -f docker-compose.yml \
                         -f ./docker/docker-compose.local.yml \
                         -f docker-compose.override.yml \
                         down
      - name: Stop Supabase
        if: always()
        run: make supabase-down

  frontend-e2e-tests:
    timeout-minutes: 60
    runs-on: ubuntu-24.04
    needs: [frontend-check, optimizer-build-test]
    steps:
      - uses: actions/checkout@v6
      - uses: actions/setup-node@v6
        with:
          node-version-file: ".nvmrc"
          cache: "npm"
          cache-dependency-path: dcapal-frontend/package-lock.json
      - name: Download dcapal-optimizer-wasm pkg
        uses: actions/download-artifact@v7
        with:
          name: dcapal-optimizer-wasm-pkg
          path: dcapal-optimizer-wasm/pkg

      - name: Install dependencies
        run: cd dcapal-frontend && npm ci

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-ms-playwright-${{ hashFiles('dcapal-frontend/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-ms-playwright-

      - name: Install Playwright Browsers
        run: cd dcapal-frontend && npx playwright install --with-deps

      - name: Run Playwright tests
        run: cd dcapal-frontend && npx playwright test

      - uses: actions/upload-artifact@v6
        if: always()
        with:
          name: playwright-report
          path: dcapal-frontend/playwright-report/
          retention-days: 30
